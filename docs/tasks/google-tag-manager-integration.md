# Интеграция Google Tag Manager и User Tracking

## Описание задачи

Интегрировать Google Tag Manager (GTM) в проект Next.js 15.3 с использованием оптимизированного компонента из `@next/third-parties`, с поддержкой консистентной идентификации пользователей. Реализовать возможность отключения GTM в режиме разработки для предотвращения ненужного отслеживания во время локальной разработки.

## Реализация

### Используемые технологии

- Next.js 15.3.1
- @next/third-parties 15.3.1
- React 19.1.0

### Файлы компонентов

1. **src/lib/user-identifier.ts**
   - Утилита для управления идентификаторами пользователей
   - Генерация и хранение UUID в localStorage и cookies
   - Поддержка cross-subdomain идентификации
   - Синхронизация с аутентифицированными пользователями
   - Имеет директиву 'use client'

2. **src/components/ui/enhanced-analytics.tsx**
   - Расширенный компонент для интеграции Google Tag Manager
   - Передача user_id в GTM 
   - Инициализация GTM с начальным dataLayer, содержащим user_id
   - Имеет директиву 'use client'

3. **src/components/ui/analytics-providers.tsx**
   - Обертка над enhanced-analytics
   - Принимает параметры для настройки в разных частях приложения
   - Имеет директиву 'use client'

4. **src/app/layout.tsx**
   - Корневой лейаут, куда добавлен `<AnalyticsProviders />`

### Особенности клиентских компонентов

Поскольку GTM и работа с идентификаторами пользователей требуют доступа к браузерным API (window, document, localStorage, cookies), все компоненты, связанные с аналитикой, отмечены директивой `'use client'`. Это указывает Next.js, что данные компоненты должны исполняться только на стороне клиента.

```tsx
'use client';

import { useEffect } from 'react';
// остальной код
```

Это необходимо для корректной работы с:
- Хуком `useEffect` для отслеживания событий
- Доступом к `window.dataLayer`
- Работой с localStorage и cookies
- Отправкой событий через API Google Tag Manager

### Управление средой разработки

Компонент умеет определять режим работы (разработка/продакшн) с помощью проверки `process.env.NODE_ENV === 'development'` и по умолчанию отключает загрузку GTM в режиме разработки.

Для включения GTM в режиме разработки:
```tsx
<AnalyticsProviders skipInDevelopment={false} />
```

### Передача user_id

В Google Tag Manager передается user_id с помощью:

1. Начального dataLayer при инициализации GTM:
```js
<GoogleTagManager
  gtmId={gtmId}
  dataLayer={{ user_id: userData.userId }}
/>
```

2. События после загрузки страницы:
```js
sendGTMEvent({
  event: 'user_identified',
  user_id: userData.userId,
  user_properties: {
    is_returning_user: userData.isReturningUser,
    referrer: userData.referrer,
    initial_path: userData.initialPath
  }
});
```

### Дополнительные аналитические сервисы

Дополнительные сервисы аналитики (Microsoft Clarity, Hotjar, Yandex Metrika и т.д.) рекомендуется настраивать через интерфейс Google Tag Manager, а не напрямую в коде.

Это обеспечивает:
- Централизованное управление всеми скриптами
- Единый пользовательский идентификатор для всех систем
- Возможность включать/отключать сервисы без обновления кода
- Лучшую производительность и меньшее количество скриптов на странице

### Переменные окружения

Для работы GTM требуется настройка переменной окружения:

```
NEXT_PUBLIC_GOOGLE_TAG_MANAGER_ID=GTM-XXXXXXX
```

Это можно сделать в файле `.env.local` (не включается в систему контроля версий) или через переменные окружения на сервере развертывания.

## Логика работы

1. В режиме разработки (`NODE_ENV === 'development'`):
   - GTM не загружается по умолчанию
   - В консоли появляется информационное сообщение
   - Можно принудительно включить через параметр компонента

2. В производственном режиме (`NODE_ENV === 'production'`):
   - GTM всегда загружается, если указан корректный ID
   - Если ID не указан, скрипт не будет загружен
   - Каждому пользователю присваивается уникальный UUID
   - ID пользователя сохраняется в localStorage и cookies
   - ID передается в Google Tag Manager и далее доступен всем сервисам внутри GTM

## Преимущества решения

1. Использование `@next/third-parties` вместо ручного добавления скрипта через `next/script` дает оптимизированную загрузку
2. Предотвращение ненужного отслеживания в режиме разработки
3. Гибкая настройка через переменные окружения
4. Код аналитики изолирован в отдельных компонентах для лучшей поддержки
5. Соответствует рекомендациям Next.js 15.3 по интеграции сторонних сервисов
6. Консистентная идентификация пользователей через различные сервисы
7. Правильная передача user_id в соответствии с документацией Google Analytics 4
8. Поддержка централизованного управления через интерфейс GTM 