# Проблемы и решения со слагами и форматированием frontmatter в ContentLayer

## Обзор проблемы

В проекте SuperDuperAI Landing с использованием ContentLayer2 для управления контентом были выявлены несколько критических проблем, связанных с форматированием frontmatter в MDX-файлах и несоответствием слагов между языковыми версиями контента.

## Выявленные проблемы

### 1. Некорректное форматирование YAML во frontmatter

MDX-файлы содержали ошибки форматирования в секции frontmatter, которые приводили к проблемам при парсинге ContentLayer:

**Пример проблемного форматирования**:

```yaml
locale: ru
seo:
title: "Генератор видео AI"
description: "Создавайте видео с помощью искусственного интеллекта"
keywords: - AI видео - генератор видео - AI генератор
```

Основные проблемы:

- Отсутствие корректных отступов для вложенных полей
- Неправильное форматирование массивов (keywords)
- Отсутствие кавычек для строковых значений, содержащих специальные символы

### 2. Несоответствие слагов между языками

Для одного и того же контента в разных языковых версиях использовались разные слаги, что нарушало работу переключения языков:

**Пример несоответствия слагов**:

```
Английская версия: /en/case/video-story
Русская версия: /ru/case/ai-video-generator
```

Это приводило к невозможности корректного перехода между языковыми версиями одной и той же страницы.

### 3. Различные стили наименования слагов

В проекте использовались разные стили наименования слагов:

- С приставкой "ai-": `ai-text-generator`
- Без приставки: `text-generator`
- С суффиксом "-generator": `text-generator`
- Без суффикса: `text`

Это создавало путаницу и усложняло логику поиска соответствующего контента.

## Реализованные решения

### 1. Исправление форматирования frontmatter

**Правильное форматирование YAML**:

```yaml
locale: "ru"
seo:
  title: "Генератор видео AI"
  description: "Создавайте видео с помощью искусственного интеллекта"
  keywords:
    - "AI видео"
    - "генератор видео"
    - "AI генератор"
```

Ключевые исправления:

- Добавлены двойные отступы для вложенных полей
- Добавлены кавычки для всех строковых значений
- Правильное форматирование массивов с использованием дефисов и отступов

### 2. Унификация слагов между языками

Для всех MDX-файлов была проведена унификация слагов, чтобы обеспечить соответствие между языковыми версиями:

```yaml
# Английская версия
slug: "video-story"
locale: "en"

# Русская версия (тот же слаг)
slug: "video-story"
locale: "ru"
```

### 3. Обработка несоответствий в middleware

Для обеспечения обратной совместимости и обработки возможных несоответствий в middleware была добавлена логика нормализации слагов:

```typescript
// Обработка возможных несоответствий слагов между языками
if (contentType === "case" && slug.startsWith("ai-")) {
  const baseSlug = slug.replace(/^ai-/, "").replace(/-generator$/, "");

  // Пробуем более простой вариант слага, если baseSlug не пустой
  if (baseSlug) {
    slug = baseSlug;
  }
}
```

Это позволяет обрабатывать старые URL, которые могли быть проиндексированы поисковыми системами или сохранены пользователями.

### 4. Улучшение поиска контента в компонентах страниц

Была улучшена логика поиска контента с учетом возможных несоответствий слагов:

```typescript
export default async function CasePage({ params }: PageProps) {
  const { slug, locale } = await params;

  // Сначала ищем точное соответствие по слагу и локали
  const caseItem = allCases.find(
    (caseItem) => caseItem.slug === slug && caseItem.locale === locale
  );

  if (!caseItem) {
    // Если не найдено, пробуем найти контент с таким же слагом на любом языке
    const fallbackCase = allCases.find((caseItem) => caseItem.slug === slug);

    if (!fallbackCase) {
      // Если всё ещё не найдено, пробуем применить нормализацию слага
      const normalizedSlug = normalizeSlug(slug);
      const normalizedCase = allCases.find(
        (caseItem) =>
          normalizeSlug(caseItem.slug) === normalizedSlug &&
          caseItem.locale === locale
      );

      if (!normalizedCase) {
        return notFound();
      }

      return CasePageContent({ caseItem: normalizedCase, slug });
    }

    // Используем доступный кейс, когда нет перевода для текущей локали
    return CasePageContent({ caseItem: fallbackCase, slug });
  }

  return CasePageContent({ caseItem, slug });
}

// Функция для нормализации слагов
function normalizeSlug(slug: string): string {
  return slug
    .replace(/^ai-/, "")
    .replace(/-generator$/, "")
    .replace(/-ai$/, "");
}
```

## Примеры исправленных файлов

### До исправления

```mdx
---
title: AI-генератор видеоисторий
slug: ai-video-generator
locale: ru
seo:
title: "AI создание видеоисторий"
description: "Создавайте захватывающие видеоистории с помощью ИИ"
keywords: - видеоистории - AI видео - генератор историй
---

# AI-генератор видеоисторий

...
```

### После исправления

```mdx
---
title: "AI-генератор видеоисторий"
slug: "video-story"
locale: "ru"
seo:
  title: "AI создание видеоисторий"
  description: "Создавайте захватывающие видеоистории с помощью ИИ"
  keywords:
    - "видеоистории"
    - "AI видео"
    - "генератор историй"
---

# AI-генератор видеоисторий

...
```

## Превентивные меры

Для предотвращения подобных проблем в будущем рекомендуется:

1. **Создать шаблоны контента** с правильным форматированием YAML
2. **Добавить валидацию frontmatter** при коммите через pre-commit хуки
3. **Документировать правила именования слагов** и обеспечить их соблюдение
4. **Использовать автоматическую генерацию слагов** на основе заголовка с одинаковой логикой для всех языков
5. **Внедрить систему проверки соответствия слагов** между языковыми версиями

## Влияние на SEO и пользовательский опыт

Исправление проблем со слагами и форматированием frontmatter имеет важные последствия:

1. **SEO-оптимизация**:

   - Предотвращение дублирования контента с разными URL
   - Корректная индексация контента поисковыми системами

2. **Пользовательский опыт**:

   - Стабильная работа переключения языков
   - Понятные и предсказуемые URL

3. **Обратная совместимость**:
   - Обработка старых URL через нормализацию слагов
   - Предотвращение ошибок 404 для уже проиндексированных страниц

## Технический долг и дальнейшие улучшения

Несмотря на проведенные исправления, остаются области для дальнейшего улучшения:

1. **Автоматизация проверки форматирования** MDX-файлов
2. **Более строгая схема валидации** в ContentLayer с информативными сообщениями об ошибках
3. **Инструменты для контент-менеджеров** для упрощения работы с frontmatter
4. **Улучшенная документация** по созданию и редактированию контента

## Заключение

Решение проблем со слагами и форматированием frontmatter в ContentLayer значительно улучшило стабильность и производительность проекта SuperDuperAI Landing. Унифицированные слаги и правильное форматирование YAML обеспечивают корректную работу системы локализации и улучшают пользовательский опыт.
