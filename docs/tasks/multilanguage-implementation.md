# Реализация мультиязычности в SuperDuperAI Next.js 15

## Обзор задачи

Мы успешно реализовали мультиязычность для сайта SuperDuperAI на основе Next.js 15, с поддержкой чистых URL и правильной установкой атрибута lang. Основной задачей было обеспечить:

1. **Чистые URL для главной страницы** - чтобы при переходе на "/" не было переброса на "/en" или "/ru" в адресной строке
2. **Правильная установка атрибута lang** - для SEO и доступности
3. **Поддержка асинхронных параметров маршрута в Next.js 15** - для корректной работы системы

## Проблемы и решения

### 1. Проблема: Чистые URL для главной страницы

**Проблема:** В стандартной реализации интернационализации Next.js происходит перенаправление с "/" на "/locale", что меняет URL в адресной строке.

**Решение:**

- Использовали `NextResponse.rewrite()` вместо `redirect()` в middleware для запросов к корневому пути
- Это позволяет внутренне загрузить контент с правильной локалью, но сохранить чистый URL в браузере
- Добавили специальную обработку в компоненте LanguageSwitcher для работы с главной страницей

```ts
// В middleware.ts
if (pathname === "/" && i18n.preserveRouteOnHome) {
  const url = new URL(`/${locale}${pathname}`, request.url);
  return NextResponse.rewrite(url);
}
```

### 2. Проблема: Установка атрибута lang в HTML

**Проблема 1:** Параметр locale в корневом layout.tsx всегда undefined, так как он находится вне [locale] директории.

**Попытка решения:** Создать локализованный layout с enhanceHtml=true для установки lang.
**Новая проблема:** Возникла ошибка гидратации из-за конфликта HTML тегов.

**Финальное решение:**

1. В корневом layout.tsx установили базовый атрибут `lang="x-default"`
2. Создали клиентский локализованный layout, который использует JavaScript для динамической установки правильного атрибута lang
3. Добавили альтернативные ссылки с атрибутом hrefLang для SEO

```tsx
// В app/layout.tsx
<html
  lang="x-default"
  className="dark"
  suppressHydrationWarning
>
  <head>
    {i18n.locales.map((locale) => (
      <link
        key={locale}
        rel="alternate"
        hrefLang={locale}
        href={`https://superduperai.co/${locale}`}
      />
    ))}
    <link
      rel="alternate"
      hrefLang="x-default"
      href="https://superduperai.co/"
    />
  </head>
  {/* ... */}
</html>
```

```tsx
// В app/[locale]/layout.tsx (клиентский компонент)
useEffect(() => {
  if (!locale) return;

  const htmlTag = document.documentElement;
  if (htmlTag.lang !== locale) {
    htmlTag.lang = locale;
  }
}, [locale]);
```

### 3. Проблема: Асинхронные параметры в Next.js 15

**Проблема:** В Next.js 15 параметры маршрута стали асинхронными, что требует обновления всех компонентов, использующих params.

**Решение:**

1. В серверных компонентах добавили `await` перед использованием params:

   ```tsx
   const locale = await params.locale;
   ```

2. В клиентских компонентах реализовали асинхронную обработку:

   ```tsx
   const [locale, setLocale] = useState("");

   useEffect(() => {
     const getLocale = async () => {
       const value = await params.locale;
       setLocale(value);
     };
     getLocale();
   }, [params.locale]);
   ```

3. Добавили обработку ошибок для повышения надежности:
   ```tsx
   try {
     const locale = await params.locale;
     // ...
   } catch (error) {
     console.error("Error:", error);
     // Запасной вариант
   }
   ```

## Архитектура решения

### Директории и файлы

- `/src/app/layout.tsx` - Корневой layout с `lang="x-default"` и альтернативными ссылками
- `/src/app/[locale]/layout.tsx` - Клиентский локализованный layout для установки правильного атрибута lang
- `/src/middleware.ts` - Middleware для перенаправления на локализованные URL и обработки чистых URL
- `/src/config/i18n-config.ts` - Конфигурация i18n с настройками для cookie и чистых URL
- `/src/components/landing/navbar.tsx` - Компонент с LanguageSwitcher для переключения языков

### Основные механизмы

1. **Middleware с rewrite для чистых URL:**

   - Перехватывает запросы и использует rewrite вместо redirect для главной страницы
   - Определяет предпочтительный язык пользователя на основе cookie или заголовка Accept-Language

2. **Двухуровневая система layout-ов:**

   - Корневой layout с базовым `lang="x-default"` и альтернативными ссылками
   - Локализованный layout для установки правильного атрибута lang через JavaScript

3. **Обработка асинхронных параметров:**

   - В серверных компонентах: `await params.locale`
   - В клиентских компонентах: асинхронное получение через useState и useEffect

4. **LanguageSwitcher с специальной обработкой для главной страницы:**
   - Обновляет cookie с выбранным языком
   - Использует разную логику для главной страницы и других страниц

## Тестирование

1. **Чистые URL для главной страницы:**

   - При прямом доступе к "/" должен загружаться контент на языке пользователя без изменения URL
   - При переключении языка на главной странице URL должен оставаться "/"

2. **Атрибут lang:**

   - Для корневого пути в исходном HTML должен быть `lang="x-default"`
   - После загрузки страницы атрибут lang должен измениться на выбранный язык
   - На других страницах должен быть установлен правильный атрибут lang

3. **Переключение языка:**
   - Переключение должно обновлять cookie
   - Для главной страницы URL должен оставаться чистым
   - Для других страниц должен изменяться только сегмент локали в URL

## Заключение

Реализованное решение обеспечивает:

1. **Чистые URL для главной страницы** - пользователь всегда видит "/" в адресной строке
2. **Правильный атрибут lang** - улучшает SEO и доступность
3. **Поддержку асинхронных параметров Next.js 15** - обеспечивает совместимость с новыми функциями

Система готова к расширению на новые языки и полностью совместима со всеми требованиями современного SEO для многоязычных сайтов.

## Следующие шаги

1. Автоматизация процесса локализации контента
2. Добавление поддержки новых языков
3. Улучшение хранения и управления переводами интерфейса
4. Реализация инструментов для контент-менеджеров
